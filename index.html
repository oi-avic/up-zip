<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>up-zip — 上传 ZIP 文件</title>
  <style>
    body { font-family: system-ui, Arial, Helvetica, sans-serif; max-width:800px; margin:40px auto; padding:0 16px; }
    input, button { font-size:14px; padding:8px; }
    .token { width:100%; box-sizing:border-box; margin-bottom:8px; }
    .message { margin-top:12px; color:#333; word-break:break-word; }
    pre { background:#f6f8fa; padding:12px; overflow:auto; }
    .note { color:#666; font-size:13px; }
  </style>
</head>
<body>
  <h1>up-zip — 上传 ZIP 文件</h1>

  <p class="note">说明：此演示会把 ZIP 文件以 base64 放入仓库 issue 的 body 中。随后仓库中的 GitHub Action 会在 issue 打开时处理该内容并把文件写入 <code>uploads/</code> 目录并提交到仓库。Action 使用内置的 <code>GITHUB_TOKEN</code> 来提交，因此无需在后端保存高权限凭据。</p>

  <label for="token">GitHub Personal Access Token（用于创建 issue。建议在测试完后立即撤销或旋转）：</label><br/>
  <input id="token" class="token" placeholder="在此粘贴你的 token（本地/测试使用）" />

  <p>
    <input type="file" id="zipFile" accept=".zip" />
    <button id="uploadBtn">上传到仓库</button>
  </p>

  <p id="message" class="message"></p>

  <h2>格式说明（调试）</h2>
  <p>Action 期望 issue.body 为 JSON，例如：</p>
  <pre>{
  "path": "uploads/example.zip",
  "content": "<base64-content>"
}</pre>

  <script>
    async function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('读取文件失败'));
        reader.onload = () => {
          const txt = reader.result;
          // data:<mime>;base64,<data>
          const idx = txt.indexOf(',');
          resolve(idx >= 0 ? txt.slice(idx + 1) : txt);
        };
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById('zipFile');
      const tokenInput = document.getElementById('token');
      const messageEl = document.getElementById('message');
      const file = fileInput.files[0];
      const token = tokenInput.value.trim();
      const owner = 'oi-avic';
      const repo = 'up-zip';

      messageEl.textContent = '';

      if (!file) { messageEl.textContent = '请选择一个 ZIP 文件。'; return; }
      if (!token) { messageEl.textContent = '请输入你的 GitHub token（仅用于创建 issue）。'; return; }

      try {
        messageEl.textContent = '正在读取文件...';
        const base64 = await readFileAsBase64(file);

        const payload = { path: `uploads/${file.name}`, content: base64 };
        const issueTitle = `up-zip upload: ${file.name}`;
        const issueBody = JSON.stringify(payload);

        messageEl.textContent = '正在创建 issue，GitHub Actions 将会处理并保存文件（请稍候）...';

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/issues`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title: issueTitle, body: issueBody })
        });

        const data = await resp.json();
        if (resp.ok) {
          messageEl.innerHTML = `已创建 issue：<a href="${data.html_url}" target="_blank" rel="noopener">${data.html_url}</a><br/>等待 GitHub Actions 处理并提交文件到仓库。`;
        } else {
          messageEl.textContent = `创建 issue 失败：${data.message || JSON.stringify(data)}`;
          console.error('create issue failed', data);
        }
      } catch (err) {
        console.error(err);
        messageEl.textContent = '发生错误，请查看浏览器控制台。';
      }
    });
  </script>
</body>
</html>
