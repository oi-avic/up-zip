<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ZIP文件上传</title>
</head>
<body>
    <h1>上传ZIP文件</h1>
    <input type="file" id="zipFile" accept=".zip" />
    <button onclick="uploadFile()">上传</button>
    <p id="message"></p>

    <script>
        async function uploadFile() {
            const fileInput = document.getElementById('zipFile');
            const messageEl = document.getElementById('message');
            const file = fileInput.files[0];

            // TODO: 如果你仍在前端测试，可以临时填入 token（不推荐在公开仓库或线上环境使用）
            const owner = 'oi-avic';
            const repo = 'up-zip'; // 只写仓库名，不要写 owner/repo 两次
            const token = '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
'; // 建议在本地临时使用并尽快撤销/旋转
            const path = `uploads/${file.name}`;

            if (!file) {
                messageEl.textContent = '请选择一个文件。';
                return;
            }

            try {
                const contentBase64 = await readFileAsBase64(file);
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github+json',
                    'Content-Type': 'application/json',
                };

                // 先查询是否存在以获取 sha（如果存在需要在 PUT 中带 sha 来更新）
                const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
                const getResp = await fetch(getUrl, { method: 'GET', headers });
                let body = {
                    message: `上传ZIP文件: ${file.name}`,
                    content: contentBase64,
                };

                if (getResp.ok) {
                    const existing = await getResp.json();
                    if (existing && existing.sha) {
                        body.sha = existing.sha;
                    }
                } else {
                    // 如果不是 404，打印错误信息以便诊断（401 -> Bad credentials）
                    if (getResp.status !== 404) {
                        const err = await getResp.json().catch(() => ({}));
                        messageEl.textContent = `上传前检查失败：${getResp.status} ${err.message || ''}`;
                        return;
                    }
                }

                // 创建或更新文件
                const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
                const putResp = await fetch(putUrl, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(body)
                });

                const result = await putResp.json();
                if (putResp.ok) {
                    messageEl.textContent = `文件上传成功！`;
                } else {
                    messageEl.textContent = `上传失败：${result.message || JSON.stringify(result)}`;
                }
            } catch (error) {
                console.error('Error:', error);
                messageEl.textContent = '发生了一个错误。';
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
